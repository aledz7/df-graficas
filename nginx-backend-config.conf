# ============================================================
# Configuração CORRIGIDA do nginx para o backend Laravel
# ============================================================
# 
# PROBLEMA ORIGINAL na sua configuração:
#   rewrite ^/backend/?(.*)$ /backend/index.php?$1 last;
#   fastcgi_param REQUEST_URI /$query_string;
#
# Isso estava ERRADO porque:
# 1. O rewrite com "?$1" coloca tudo após /backend como query string
# 2. Quando há query string na URL original (?per_page=100), ela vira &per_page=100
# 3. $query_string não contém o path, só a query string
#
# SOLUÇÃO:
# - Usar try_files que preserva corretamente path e query string
# - Usar $request_uri completo e remover /backend antes de passar ao Laravel

location /backend {
    try_files $uri $uri/ /backend/index.php$is_args$args;
}

location ~ ^/backend/index\.php(/|$) {
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME /var/www/html/df-graficas/backend/public/index.php;
    fastcgi_param SCRIPT_NAME /backend/index.php;
    
    # CORRIGIDO: Remove /backend do início do REQUEST_URI
    # Exemplo: /backend/api/cores?per_page=100 -> /api/cores?per_page=100
    # Isso preserva o "?" corretamente na query string
    set $laravel_uri $request_uri;
    if ($request_uri ~ ^/backend/(.*)$) {
        set $laravel_uri /$1;
    }
    
    fastcgi_param REQUEST_URI $laravel_uri;
    fastcgi_pass unix:/run/php/php8.2-fpm.sock;
    fastcgi_index index.php;
}

location /backend/storage {
    alias /var/www/html/df-graficas/backend/storage/app/public;
}
